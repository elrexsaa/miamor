<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valentine's</title>
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Dancing+Script:wght@700&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #ff4081; --secondary: #ff85a2; --bg: #fce4ec; --text: #ad1457; --white: #ffffff; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: var(--bg); height: 100vh; overflow: hidden; color: var(--text); }

        /* --- LOCKSCREEN --- */
        #lock-screen { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; text-align: center; padding: 20px; background: var(--bg); position: fixed; width: 100%; z-index: 9999; }
        .dots-container { display: flex; gap: 15px; margin: 20px 0 40px; }
        .dot { width: 14px; height: 14px; border: 2px solid var(--primary); border-radius: 50%; transition: 0.3s; }
        .dot.active { background: var(--primary); transform: scale(1.3); }
        .keypad { display: grid; grid-template-columns: repeat(3, 75px); gap: 15px; }
        .key { width: 75px; height: 75px; border-radius: 50%; background: var(--white); display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 4px 15px rgba(255, 64, 129, 0.1); font-weight: 600; transition: 0.2s; }
        .key:active { background: var(--primary); color: white; transform: scale(0.9); }

        /* --- MAIN APP --- */
        #main-app { display: none; height: 100vh; flex-direction: column; background: #fffcfd; }
        .top-bar { padding: 18px; text-align: center; background: var(--white); border-bottom: 1px solid rgba(255, 64, 129, 0.1); font-weight: 600; font-size: 1.1rem; }
        .content { flex: 1; padding: 15px; overflow-y: auto; padding-bottom: 90px; }
        .hidden { display: none !important; }

        /* --- HUG BUTTON --- */
        .hug-btn {
            display: none; /* Muncul lewat JS */
            margin: 20px auto;
            padding: 12px 25px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 50px;
            font-weight: 600;
            box-shadow: 0 10px 20px rgba(255, 64, 129, 0.2);
            cursor: pointer;
            animation: fadeIn 0.8s ease forwards;
        }

        /* --- CHAT UI --- */
        #menu-chat { display: flex; flex-direction: column; height: 100%; }
        #chat-window { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; }
        .bubble { max-width: 80%; padding: 12px 16px; border-radius: 20px; font-size: 0.95rem; line-height: 1.4; animation: fadeIn 0.4s ease; }
        .bubble.ai { align-self: flex-start; background: var(--white); color: #444; border-bottom-left-radius: 4px; border: 1px solid #fce4ec; }
        .bubble.user { align-self: flex-end; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border-bottom-right-radius: 4px; }
        .chat-input-container { padding: 15px; background: var(--white); display: flex; gap: 10px; align-items: center; border-radius: 30px; margin-top: 10px; box-shadow: 0 -5px 20px rgba(0,0,0,0.02); }
        #chat-input { flex: 1; border: none; outline: none; padding: 5px 10px; background: transparent; }
        #send-btn { background: var(--primary); border: none; width: 40px; height: 40px; border-radius: 50%; color: white; cursor: pointer; display: flex; justify-content: center; align-items: center; }

        /* --- GAME & CAMERA --- */
        #game-container { position: relative; width: 100%; height: 350px; background: #000; border-radius: 25px; overflow: hidden; }
        #video-feed { position: absolute; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); z-index: 1; }
        #p5-canvas-holder { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; }
        .status-msg { margin: 15px 0; font-weight: 600; text-align: center; color: var(--text); }

        /* --- POPUP SMILE --- */
        #smile-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--white); padding: 25px; border-radius: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.15); text-align: center; z-index: 9999; opacity: 0; visibility: hidden; transition: 0.4s; width: 80%; }
        #smile-popup.show { opacity: 1; visibility: visible; }
        #smile-popup img { width: 130px; margin: 15px 0; border-radius: 15px; }

        /* --- NAV --- */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; height: 80px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); display: flex; justify-content: space-around; align-items: center; z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; color: #bbb; cursor: pointer; transition: 0.3s; }
        .nav-item.active { color: var(--primary); transform: translateY(-5px); font-weight: 600; }
        .nav-item span:first-child { font-size: 1.6rem; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="lock-screen">
        <h2 style="font-family: 'Dancing Script', cursive; font-size: 2.5rem; color: var(--text); margin-bottom: 10px;">For You</h2>
        <p style="font-size: 0.9rem; opacity: 0.7; margin-bottom: 20px;">Gatau? tanya elga.</p>
        <div class="dots-container" id="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
        <div class="keypad">
            <script>for(let i=1; i<=9; i++) document.write(`<div class="key" onclick="pressKey('${i}')">${i}</div>`);</script>
            <div class="key" onclick="clearPin()">C</div><div class="key" onclick="pressKey('0')">0</div>
        </div>
    </div>

    <div id="main-app">
        <div class="top-bar" id="page-title">üíå Notes</div>
        
        <div class="content">
            <div id="menu-pesan" style="text-align: center;">
                <p id="typing-text" style="line-height: 2; color: #555; white-space: pre-wrap; font-size: 1.05rem; text-align: left;"></p>
                <button id="hug-btn" class="hug-btn" onclick="virtualHug()">ü§ó Minta Pelukan Virtual</button>
            </div>

            <div id="menu-chat" class="hidden">
                <div id="chat-window">
                    <div class="bubble ai">Halo sayang... Aku di sini. Ada yang mau kamu ceritain atau tanyain ke aku? ‚ù§Ô∏è</div>
                </div>
                <div class="chat-input-container">
                    <input type="text" id="chat-input" placeholder="Tulis pesan..." onkeypress="handleEnter(event)">
                    <button id="send-btn" onclick="sendMessage()">‚ù§Ô∏è</button>
                </div>
            </div>

            <div id="menu-playlist" class="hidden">
                <iframe style="border-radius:20px" src="https://open.spotify.com/embed/playlist/37i9dQZF1DX4pUK31fDr9t" width="100%" height="352" frameBorder="0" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"></iframe>
            </div>

            <div id="menu-game" class="hidden">
                <div id="game-container">
                    <video id="video-feed" autoplay muted playsinline></video>
                    <div id="p5-canvas-holder"></div>
                </div>
                <div class="status-msg" id="status-text">Memuat AI...</div>
            </div>
        </div>

        <nav class="bottom-nav">
            <div class="nav-item active" onclick="switchMenu('pesan', this)"><span>üíå</span><span>Pesan</span></div>
            <div class="nav-item" onclick="switchMenu('chat', this)"><span>üí¨</span><span>Curhat</span></div>
            <div class="nav-item" onclick="switchMenu('playlist', this)"><span>üéµ</span><span>Lagu</span></div>
            <div class="nav-item" onclick="switchMenu('game', this)"><span>üéÆ</span><span>Game</span></div>
        </nav>
    </div>

    <div id="smile-popup">
        <h3 id="popup-text"></h3>
        <img id="popup-gif" src="" alt="Love GIF">
        <p style="font-size: 0.8rem; opacity: 0.6;">I Love Your Smile!</p>
    </div>

    <script>
        // --- KONFIGURASI ---
        const PIN = "2009";
        const GROQ_API_KEY = "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"; 
        
        let currentInput = "";
        let isHappy = false;
        let particles = [];
        let modelsLoaded = false;
        let lastSmileState = false;

        const smileMessages = [
            { text: "Alalalah manisnyaaü§≠", gif: "https://media2.giphy.com/media/v1.Y2lkPTZjMDliOTUya28wNjAzOG54cjVvMWgzYXQ2ZDBsaWN4Zm4wb3lpdjMyNno4aTF3dyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/DdrPPh7s1eOzSFNGJL/giphy.gif" },
            { text: "SUMPAHH‚ÅâÔ∏è MANISNYAA", gif: "https://media4.giphy.com/media/v1.Y2lkPTZjMDliOTUycmh4bXlicjJyandiZGRubGI2eGV5amcwN3VjaXc3b3NvMTRiZHc5NCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/dj81KyJ2frDAWDYTAy/giphy.gif" },
            { text: "Aduh, gemesnya! üíñ", gif: "https://media0.giphy.com/media/v1.Y2lkPTZjMDliOTUyM3MyZm83bmVvdzV2aG9wODVnbWh2MWtteHczczIzemw3YnN4MGEyeiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/w0c504VU6cNGs13QJp/giphy.gif" }
        ];

        // --- AUTH ---
        function pressKey(num) {
            if (currentInput.length < 4) {
                currentInput += num;
                updateDots();
                if (currentInput.length === 4) {
                    if(currentInput === PIN) {
                        confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                        document.getElementById('lock-screen').style.display = 'none';
                        document.getElementById('main-app').style.display = 'flex';
                        startTyping();
                    } else {
                        clearPin();
                    }
                }
            }
        }
        function updateDots() { document.querySelectorAll('.dot').forEach((d, i) => d.classList.toggle('active', i < currentInput.length)); }
        function clearPin() { currentInput = ""; updateDots(); }

        // --- VIRTUAL HUG ---
        function virtualHug() {
            if ("vibrate" in navigator) {
                // Pola: Getar 200ms, jeda 100, getar 500ms (detak jantung)
                navigator.vibrate([200, 100, 500]);
            }
            confetti({
                particleCount: 40,
                spread: 50,
                origin: { y: 0.8 },
                colors: ['#ff4081', '#ffffff']
            });
            alert("Rasain getarannya? Itu pelukan virtual dari aku buat kamu! ü•∞‚ù§Ô∏è");
        }

        // --- CHAT AI LOGIC ---
        function handleEnter(e) { if(e.key === "Enter") sendMessage(); }
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const chatWindow = document.getElementById('chat-window');
            const text = input.value.trim();
            if(!text) return;
            addBubble(text, 'user');
            input.value = "";
            const loadingBubble = addBubble("Sedang mengetik...", 'ai');
            try {
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${GROQ_API_KEY}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "llama-3.3-70b-versatile",
                        messages: [
                            { role: "system", content: "kamu adalah pacar virtual untuk nikita, tapi kamu sadar kalau nikita itu pacarnya elga. typing huruf kecil semua, vibe gen z tiktok, santai, dukung hubungan dia sama elga." },
                            { role: "user", content: text }
                        ]
                    })
                });
                const data = await response.json();
                loadingBubble.remove();
                addBubble(data.choices[0].message.content, 'ai');
            } catch (err) {
                loadingBubble.innerText = "Aduh sayang, koneksiku lagi bermasalah.. ‚ù§Ô∏è";
            }
        }
        function addBubble(msg, type) {
            const win = document.getElementById('chat-window');
            const b = document.createElement('div');
            b.className = `bubble ${type}`;
            b.innerText = msg;
            win.appendChild(b);
            win.scrollTop = win.scrollHeight;
            return b;
        }

        // --- CAMERA & SMILE ---
        async function loadModels() {
            if (modelsLoaded) return;
            const URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1/model';
            await faceapi.nets.tinyFaceDetector.loadFromUri(URL);
            await faceapi.nets.faceExpressionNet.loadFromUri(URL);
            modelsLoaded = true;
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } }).then(s => {
                document.getElementById('video-feed').srcObject = s;
                detect();
            });
        }
        async function detect() {
            const video = document.getElementById('video-feed');
            setInterval(async () => {
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
                if (detections.length > 0) {
                    isHappy = detections[0].expressions.happy > 0.5;
                    if (isHappy && !lastSmileState) showSmilePopup();
                    lastSmileState = isHappy;
                    document.getElementById('status-text').innerText = isHappy ? "CANTIKNYA! ‚ù§Ô∏è" : "Mana senyum manisnya? ü§®";
                }
            }, 200);
        }
        function showSmilePopup() {
            const p = document.getElementById('smile-popup');
            const m = smileMessages[Math.floor(Math.random()*smileMessages.length)];
            document.getElementById('popup-text').innerText = m.text;
            document.getElementById('popup-gif').src = m.gif;
            p.classList.add('show');
            setTimeout(() => p.classList.remove('show'), 3500);
        }

        // --- P5 ENGINE ---
        let sketch = function(p) {
            p.setup = function() {
                let h = document.getElementById('p5-canvas-holder');
                p.createCanvas(h.offsetWidth, h.offsetHeight).parent(h);
                for (let i = 0; i < 80; i++) particles.push(new Heart(p));
            };
            p.draw = function() {
                p.clear();
                particles.forEach(pt => { pt.update(isHappy); pt.show(); });
            };
        };
        class Heart {
            constructor(p) { this.p = p; this.pos = p.createVector(p.random(p.width), p.random(p.height)); this.vel = p5.Vector.random2D(); this.t = p.random(p.TWO_PI); }
            update(forming) {
                if (forming) {
                    let x = 16 * Math.pow(Math.sin(this.t), 3);
                    let y = -(13 * Math.cos(this.t) - 5 * Math.cos(2*this.t) - 2 * Math.cos(3*this.t) - Math.cos(4*this.t));
                    let target = this.p.createVector(this.p.width/2 + x*7, this.p.height/2 + y*7);
                    this.pos.lerp(target, 0.1);
                } else {
                    this.pos.add(this.vel);
                    if(this.pos.x<0||this.pos.x>this.p.width)this.vel.x*=-1;
                    if(this.pos.y<0||this.pos.y>this.p.height)this.vel.y*=-1;
                }
            }
            show() { this.p.fill(255, 64, 129, 200); this.p.noStroke(); this.p.ellipse(this.pos.x, this.pos.y, 6); }
        }
        new p5(sketch);

        // --- TYPING ---
        function startTyping() {
            const txt = "Halo sayang... ‚ú®\n\nMakasih ya udah selalu ada. Aku bikin ini khusus buat kamu.\n\nCoba buka menu Game buat senyum bareng, atau Curhat kalau kamu lagi kangen aku. I love you! ‚ù§Ô∏è";
            let i = 0;
            const target = document.getElementById('typing-text');
            function type() {
                if (i < txt.length) {
                    target.innerHTML += txt.charAt(i);
                    i++;
                    setTimeout(type, 50);
                } else {
                    // MUNCULKAN TOMBOL HUG SETELAH TYPING SELESAI
                    document.getElementById('hug-btn').style.display = 'block';
                }
            }
            type();
        }

        function switchMenu(menu, el) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
            ['pesan', 'chat', 'playlist', 'game'].forEach(m => document.getElementById('menu-'+m).classList.add('hidden'));
            document.getElementById('menu-'+menu).classList.remove('hidden');
            document.getElementById('page-title').innerText = menu.toUpperCase();
            if(menu === 'game') loadModels();
        }
    </script>
</body>
</html>
